# Минимально жизнеспособный шэринг экрана (WebRTC)

Этот документ описывает целевую архитектуру минимального демо шэринга экрана на базе WebRTC с сигнальным сервером. Упор сделан на простоту и низкие задержки при минимуме зависимостей.

## Цели

- Один ведущий показывает экран, один или несколько зрителей смотрят.
- Нет сложной авторизации или чата — только показ экрана.
- Максимально простой обход NAT: WebRTC + STUN/TURN как запасной вариант.

## Стек

### Клиент
- Браузер (Chrome/Firefox/Edge), TypeScript/JavaScript.
- `getDisplayMedia()` для захвата экрана.
- WebRTC (`RTCPeerConnection`, `RTCDataChannel` опционально) для передачи видео.
- WebSocket для сигналинга (обмен SDP/ICE).
- UI может быть на React/Vue/Svelte или ванильный JS для демо.

### Сервер
- Node.js + TypeScript.
- HTTP API на Express/Fastify (создание/получение сессий).
- WebSocket сервер на `ws`/`socket.io` для сигналинга.
- Redis как опция для масштабирования нескольких инстансов.

### STUN/TURN
- STUN — публичный сервер из браузера или собственный.
- TURN — отдельный `coturn` сервис для фоллбэка; передаётся в `iceServers`.

## Архитектура компонентов

1. **Signaling Server (Node.js)**
   - Создаёт комнаты/сессии для участников.
   - Проксирует сообщения WebRTC оффер/ансер и ICE кандидатов.
   - Не обрабатывает медиапоток.

2. **WebRTC Peer-to-Peer**
   - Ведущий: `getDisplayMedia()` → `RTCPeerConnection` → offer.
   - Зритель: получает offer → создаёт peer → answer.
   - Обмен ICE через сигнальный сервер; медиатрафик идёт P2P или через TURN.

3. **(Опционально) Backend API**
   - POST `/sessions` → создать сессию, вернуть ID/URL.
   - GET `/sessions/:id` → метаданные или статус.
   - Токены/ограничения доступа можно добавить позже.

## Минимальный сценарий

1. **Ведущий**
   - Открывает `/presenter`, нажимает "Начать трансляцию".
   - Запрашивает `getDisplayMedia()`, создаёт `RTCPeerConnection` с `iceServers`.
   - Подключается к WebSocket сигнальному серверу; отправляет offer и ICE кандидаты.

2. **Зритель**
   - Открывает `/view/<sessionId>`.
   - Подключается к той же комнате по WebSocket.
   - Получает offer, ставит remote description, создаёт answer, отправляет его.
   - Добавляет ICE кандидаты; отображает входящий видеотрек в `<video>`.

3. **Медиа поток**
   - После обмена SDP/ICE WebRTC устанавливает соединение.
   - Трафик идёт напрямую или через TURN при необходимости.

## Минимальная структура проекта (предложение)

```
/ (workspace)
  /server
    app.ts            # Express/Fastify + ws/socket.io
    signaling.ts      # Логика комнат, обмен оффер/ансер/ICE
    config.ts         # Настройки STUN/TURN
  /client
    /presenter
      index.html
      presenter.ts    # getDisplayMedia, offer, отправка ICE
    /viewer
      index.html
      viewer.ts       # обработка offer, answer, ICE
  /docs
    screen-sharing-mvp.md
```

## Настройки STUN/TURN (пример)

```ts
const iceServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  {
    urls: 'turn:turn.example.com:3478',
    username: 'demo',
    credential: 'demo',
  },
];
```

## Минимальная логика сигналинга (кратко)

- Клиент подключается к WebSocket с `sessionId`.
- Типы сообщений: `offer`, `answer`, `ice-candidate`, `join`, `leave`.
- Сервер пересылает сообщения всем участникам комнаты, кроме отправителя.
- Для нескольких зрителей ведущий создаёт peer на каждого зрителя или использует однонаправленный SFU позже (в MVP — отдельный peer).

## Развитие после MVP

- Добавить авторизацию/токены на вход в комнату.
- Перейти на SFU (например, mediasoup или Janus) при росте числа зрителей.
- Добавить управление качеством/битрейтом и метрики.
- UI: отображение подключений, индикация подключённых зрителей.

